<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ProntoQA Decomposer Standalone Viewer (updated)</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--muted:#666}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
  .wrap{max-width:1200px;margin:20px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="text"], textarea, select{padding:8px;border:1px solid #d7dbe8;border-radius:8px;font-size:13px}
  .btn{padding:8px 10px;border-radius:8px;border:1px solid #d1d5e8;background:#fff;cursor:pointer;font-size:13px}
  .btn.primary{background:#3b82f6;color:#fff;border-color:transparent}
  .btn.warn{background:#f59e0b;color:#fff;border-color:transparent}
  .panel{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(20,30,60,0.06);margin-top:12px}
  .meta{color:var(--muted);font-size:13px}
  .card{background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid #eef2f8}
  .row{display:flex;gap:12px;align-items:flex-start}
  .col{flex:1}
  pre{white-space:pre-wrap;word-break:break-word;background:#fbfdff;padding:8px;border-radius:8px;border:1px solid #f0f4ff;font-size:13px}
  details summary{cursor:pointer;font-weight:600}
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .badge.A{background:#e6ffed;color:#047857}
  .badge.B{background:#fff7ed;color:#92400e}
  .badge.C{background:#fff1f2;color:#9f1239}
  .controls-right{margin-left:auto;display:flex;gap:8px}
  .small{font-size:13px;color:var(--muted)}
  .topbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .paginate{display:flex;gap:8px;align-items:center}
  .checkbox{transform:scale(1.1)}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  @media (max-width:800px){ .row{flex-direction:column} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ProntoQA Decomposer — Standalone Viewer (updated)</h1>
    <div class="meta">Open a JSON (array of objects) or use the sample.</div>
  </header>

  <div class="panel">
    <div class="controls topbar">
      <input id="file-input" type="file" accept="application/json" class="btn" />
      <button id="paste-json" class="btn">Paste JSON</button>
      <button id="load-sample" class="btn">Use Sample</button>

      <div style="width:14px"></div>

      <input id="search" type="text" placeholder="Search id / question / context..." style="min-width:260px" />

      <select id="pageSize">
        <option value="5">5 / page</option>
        <option value="10" selected>10 / page</option>
        <option value="25">25 / page</option>
        <option value="50">50 / page</option>
      </select>

      <label class="small">Show label:
        <select id="filterLabel">
          <option value="">All</option>
        </select>
      </label>

      <div class="controls-right">
        <button id="select-page" class="btn">Select page</button>
        <button id="clear-selection" class="btn">Clear selection</button>
        <button id="export-all" class="btn primary">Export CSV (all)</button>
        <button id="export-selected" class="btn">Export CSV (selected)</button>
        <button id="download-snapshot" class="btn">Download HTML snapshot</button>
      </div>
    </div>

    <div class="small" id="status">Loaded: 0 items — Selected: 0</div>

    <div id="list" style="margin-top:12px"></div>

    <div class="paginate" style="margin-top:12px;align-items:center">
      <button id="prev" class="btn">Previous</button>
      <div class="small" id="page-info">Page 1 / 1</div>
      <button id="next" class="btn">Next</button>
      <div style="flex:1"></div>
      <div class="small" id="range-info"></div>
    </div>

  </div>

  <footer>Tip: You can drag & drop a JSON file into your browser or click "Load JSON". If your file contains a single object, wrap it as a list <code>[ ... ]</code>.</footer>
</div>

<!-- Paste JSON modal -->
<div id="paste-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
  <div style="background:#fff;padding:16px;border-radius:10px;max-width:900px;width:90%;box-shadow:0 10px 38px rgba(10,20,40,0.3)">
    <h3 style="margin-top:0">Paste JSON (array of objects)</h3>
    <textarea id="paste-area" rows="12" style="width:100%;font-family:monospace"></textarea>
    <div style="margin-top:8px;text-align:right">
      <button id="paste-cancel" class="btn">Cancel</button>
      <button id="paste-load" class="btn primary">Load</button>
    </div>
  </div>
</div>

<script>
/* -------------------------
   Utilities & state
   ------------------------- */
let DATA = [];                 // full array
let FILTERED = [];             // after search & label-filter
let PAGE = 1;
let PAGE_SIZE = 10;
let SELECTED = new Set();      // selected ids
let CURRENT_PAGE_IDS = [];     // ids currently visible (for select-page)
const listNode = document.getElementById('list');
const statusNode = document.getElementById('status');
const pageInfo = document.getElementById('page-info');
const rangeInfo = document.getElementById('range-info');
const filterLabel = document.getElementById('filterLabel');

function safeText(s){ return s === null || s === undefined ? '' : String(s); }
function escapeHtml(s){ const t = document.createElement('div'); t.textContent = s; return t.innerHTML; }
function downloadBlob(content, filename, type='text/plain;charset=utf-8'){ const blob = new Blob([content], {type}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function copyToClipboard(str){ if(!navigator.clipboard){ alert('Clipboard not available'); return; } navigator.clipboard.writeText(str).then(()=>{/*ok*/}).catch(e=>alert('Copy failed: '+e.message)); }
function toCSV(rows, fields){ const esc=(s)=>{ if(s===null||s===undefined) return ''; const str=String(s).replace(/"/g,'""'); return `"${str}"`; }; const lines=[fields.map(f=>esc(f)).join(',')]; for(const r of rows) lines.push(fields.map(f=>esc(r[f] ?? '')).join(',')); return lines.join('\\n'); }

/* -------------------------
   Unescape helper (turns "\\n" into real newline, "\\\\left" -> "\left", etc.)
   Works for common escaped sequences.
   ------------------------- */
function unescapeString(s){
  if(typeof s !== 'string') return s;
  // Replace escaped sequences like \n \r \t into real characters
  // and then convert double-backslashes into single backslash for latex-like tokens (\\left -> \left)
  return s
    .replace(/\\\\r/g, '\\r')    // handle double-escaped forms first if present
    .replace(/\\\\n/g, '\\n')
    .replace(/\\\\t/g, '\\t')
    .replace(/\\r/g, '\r')
    .replace(/\\n/g, '\n')
    .replace(/\\t/g, '\t')
    .replace(/\\\\/g, '\\');
}

/* -------------------------
   Rendering
   ------------------------- */
function renderList(){
  listNode.innerHTML = '';
  PAGE_SIZE = Number(document.getElementById('pageSize').value || 10);
  const q = document.getElementById('search').value.trim().toLowerCase();
  const label = document.getElementById('filterLabel').value;

  // filter
  FILTERED = DATA.filter(d=>{
    if(label && (String(d.ground_truth||'') !== label)) return false;
    if(!q) return true;
    const hay = [
      d.id,
      d.question,
      d.original_context,
      (d.translated_context && JSON.stringify(d.translated_context)),
      (d.normalized_context && JSON.stringify(d.normalized_context))
    ].filter(Boolean).join(' ').toLowerCase();
    return hay.indexOf(q) !== -1;
  });

  const total = FILTERED.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(PAGE > totalPages) PAGE = totalPages;

  const start = (PAGE-1)*PAGE_SIZE;
  const end = Math.min(start + PAGE_SIZE, total);
  const pageItems = FILTERED.slice(start, end);

  CURRENT_PAGE_IDS = pageItems.map((it,i)=>it.id ?? ('idx_'+(start+i)));
  pageInfo.textContent = 'Page ' + PAGE + ' / ' + totalPages;
  rangeInfo.textContent = `Showing ${start+1} - ${end} of ${total}`;

  // update status
  statusNode.textContent = `Loaded: ${DATA.length} items — Selected: ${SELECTED.size}`;

  // render cards
  for(const item of pageItems){
    const id = item.id ?? ('idx_'+Math.random().toString(36).slice(2,8));
    const card = document.createElement('div'); card.className = 'card';
    const row = document.createElement('div'); row.className = 'row';

    // checkbox
    const checkboxWrap = document.createElement('div');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='checkbox';
    cb.checked = SELECTED.has(id);
    cb.addEventListener('change', ()=>{ if(cb.checked) SELECTED.add(id); else SELECTED.delete(id); statusNode.textContent = `Loaded: ${DATA.length} items — Selected: ${SELECTED.size}`; });
    checkboxWrap.appendChild(cb);
    row.appendChild(checkboxWrap);

    // content
    const col = document.createElement('div'); col.className = 'col';
    const title = document.createElement('div'); title.style.display='flex'; title.style.alignItems='center'; title.style.justifyContent='space-between';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${escapeHtml(id)}</div><div class="small">${escapeHtml(safeText(item.question || (item.translated_context && item.translated_context.Translated_Conjecture) || ''))}</div>`;
    title.appendChild(left);

    const badge = document.createElement('div');
    const lbl = (item.ground_truth || '-');
    const b = document.createElement('span'); b.className = 'badge ' + (lbl ? lbl : '-'); b.textContent = lbl || '-';
    if(lbl === 'A') b.className = 'badge A';
    else if(lbl === 'B') b.className = 'badge B';
    else if(lbl === 'C') b.className = 'badge C';
    else b.className = 'badge -';
    badge.appendChild(b);
    title.appendChild(badge);

    col.appendChild(title);

    const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='1fr'; grid.style.gap='10px'; grid.style.marginTop='10px';
    if(window.innerWidth > 900) grid.style.gridTemplateColumns='1fr 1fr 1fr';

    // Fact / Translated
    const factDiv = document.createElement('div');
    factDiv.innerHTML = `<div style="font-weight:600">Fact / Translated</div>`;
    const factPre = document.createElement('pre');
    let factText = '';
    if(item.translated_context && item.translated_context.Translated_Facts) factText = item.translated_context.Translated_Facts;
    else if(item.normalized_context && item.normalized_context.Fact) factText = item.normalized_context.Fact;
    else factText = safeText(item.original_context || '').slice(0,400);
    factText = unescapeString(factText);
    factPre.textContent = factText;
    factDiv.appendChild(factPre);
    const factBtns = document.createElement('div'); factBtns.style.marginTop='8px';
    const copyFactBtn = document.createElement('button'); copyFactBtn.className='btn'; copyFactBtn.textContent='Copy fact'; copyFactBtn.onclick = ()=>copyToClipboard(factPre.textContent);
    const copyTransBtn = document.createElement('button'); copyTransBtn.className='btn'; copyTransBtn.textContent='Copy translated'; copyTransBtn.onclick = ()=>copyToClipboard(JSON.stringify(item.translated_context || {}, null, 2));
    factBtns.appendChild(copyFactBtn); factBtns.appendChild(copyTransBtn);
    factDiv.appendChild(factBtns);
    grid.appendChild(factDiv);

    // Normalized / CNF
    const normDiv = document.createElement('div');
    normDiv.innerHTML = `<div style="font-weight:600">Normalized / CNF</div>`;
    const normPre = document.createElement('pre');
    // If normalized_context has large string fields (like and_or) unescape them for display
    if(item.normalized_context){
      if(typeof item.normalized_context === 'string') normPre.textContent = unescapeString(item.normalized_context);
      else {
        // If object, try to pretty-print but unescape any string field values
        const clone = {};
        for(const k in item.normalized_context){
          const v = item.normalized_context[k];
          if(typeof v === 'string') clone[k] = unescapeString(v);
          else clone[k] = v;
        }
        normPre.textContent = JSON.stringify(clone, null, 2);
      }
    } else normPre.textContent = '-';
    normDiv.appendChild(normPre);
    const normBtns = document.createElement('div'); normBtns.style.marginTop='8px';
    const copyCNF = document.createElement('button'); copyCNF.className='btn'; copyCNF.textContent='Copy CNF'; copyCNF.onclick = ()=>copyToClipboard(normPre.textContent);
    normBtns.appendChild(copyCNF);
    normDiv.appendChild(normBtns);
    grid.appendChild(normDiv);

    // Decomposition
    const decDiv = document.createElement('div');
    decDiv.innerHTML = `<div style="font-weight:600">Decomposition process</div>`;
    if(item.decomposition_process){
      const details = document.createElement('details');
      const summary = document.createElement('summary'); summary.textContent='View steps';
      details.appendChild(summary);
      const decPre = document.createElement('pre');

      // pretty-format decomposition: if string -> unescape, if object -> try to unescape string/array fields
      if(typeof item.decomposition_process === 'string'){
        decPre.textContent = unescapeString(item.decomposition_process);
      } else if(Array.isArray(item.decomposition_process)){
        // join array entries, unescape each
        decPre.textContent = item.decomposition_process.map(x => unescapeString(typeof x === 'string' ? x : JSON.stringify(x))).join('\\n\\n');
      } else {
        // object: flatten key-values with unescaped strings
        let outLines = [];
        for(const k in item.decomposition_process){
          const v = item.decomposition_process[k];
          if(typeof v === 'string') outLines.push(k + ':\\n' + unescapeString(v));
          else if(Array.isArray(v)) outLines.push(k + ':\\n' + v.map(x => unescapeString(typeof x === 'string' ? x : JSON.stringify(x))).join('\\n'));
          else outLines.push(k + ':\\n' + JSON.stringify(v, null, 2));
        }
        decPre.textContent = outLines.join('\\n\\n');
      }

      details.appendChild(decPre);
      decDiv.appendChild(details);
      const decBtns = document.createElement('div'); decBtns.style.marginTop='8px';
      const copyDec = document.createElement('button'); copyDec.className='btn'; copyDec.textContent='Copy process'; copyDec.onclick = ()=>copyToClipboard(decPre.textContent);
      decBtns.appendChild(copyDec);
      decDiv.appendChild(decBtns);
    } else {
      decDiv.innerHTML += '<div class="small">-</div>';
    }
    grid.appendChild(decDiv);

    // Raw JSON
    const rawDiv = document.createElement('div'); rawDiv.style.gridColumn = '1 / -1';
    const rawDet = document.createElement('details');
    const rawSum = document.createElement('summary'); rawSum.textContent = 'Raw JSON (click to expand)';
    rawDet.appendChild(rawSum);
    const rawPre = document.createElement('pre'); rawPre.textContent = JSON.stringify(item, null, 2);
    rawDet.appendChild(rawPre);
    const copyRaw = document.createElement('button'); copyRaw.className='btn'; copyRaw.textContent='Copy raw'; copyRaw.onclick = ()=>copyToClipboard(rawPre.textContent);
    rawDet.appendChild(copyRaw);
    rawDiv.appendChild(rawDet);
    grid.appendChild(rawDiv);

    col.appendChild(grid);
    row.appendChild(col);
    card.appendChild(row);
    listNode.appendChild(card);

    // click-on-title toggles checkbox
    title.querySelector('div').addEventListener('click', ()=>{ cb.checked = !cb.checked; cb.dispatchEvent(new Event('change'));});
  }

  refreshLabelFilterOptions();
}

/* -------------------------
   Controls handlers
   ------------------------- */
document.getElementById('pageSize').addEventListener('change', ()=>{ PAGE = 1; renderList(); });
document.getElementById('search').addEventListener('input', ()=>{ PAGE = 1; renderList(); });
document.getElementById('filterLabel').addEventListener('change', ()=>{ PAGE = 1; renderList(); });
document.getElementById('prev').addEventListener('click', ()=>{ if(PAGE > 1) PAGE--; renderList(); });
document.getElementById('next').addEventListener('click', ()=>{ const total = FILTERED.length; const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE)); if(PAGE < totalPages) PAGE++; renderList(); });
document.getElementById('select-page').addEventListener('click', ()=>{ for(const id of CURRENT_PAGE_IDS) SELECTED.add(id); statusNode.textContent = `Loaded: ${DATA.length} items — Selected: ${SELECTED.size}`; });
document.getElementById('clear-selection').addEventListener('click', ()=>{ SELECTED = new Set(); statusNode.textContent = `Loaded: ${DATA.length} items — Selected: ${SELECTED.size}`; renderList(); });
document.getElementById('export-all').addEventListener('click', ()=>{ if(DATA.length === 0) return alert('No data loaded'); const fields = ['id','question','normalized_conjecture','ground_truth']; const rows = DATA.map(d => { const o = {}; for(const f of fields) o[f] = d[f] ?? ''; return o; }); const csv = toCSV(rows, fields); downloadBlob(csv, 'prontoqa_all.csv', 'text/csv;charset=utf-8'); });
document.getElementById('export-selected').addEventListener('click', ()=>{ if(SELECTED.size === 0) return alert('No rows selected'); const rows = DATA.filter(d => SELECTED.has(d.id)); if(rows.length === 0) return alert('Selected IDs not found in data (maybe missing id field?)'); const fields = ['id','question','normalized_conjecture','ground_truth']; const csv = toCSV(rows.map(r => { const o = {}; for(const f of fields) o[f] = r[f] ?? ''; return o; }), fields); downloadBlob(csv, 'prontoqa_selected.csv', 'text/csv;charset=utf-8'); });
document.getElementById('download-snapshot').addEventListener('click', ()=>{ const htmlRows = FILTERED.map(d=>{ return `<section style="border:1px solid #ddd;padding:10px;border-radius:8px;margin-bottom:8px"><h3>${escapeHtml(d.id || '')}</h3><p><strong>Question:</strong> ${escapeHtml(d.question || '')}</p><pre>${escapeHtml(JSON.stringify(d, null, 2))}</pre></section>`; }).join('\\n'); const doc = `<!doctype html><html><head><meta charset="utf-8"><title>ProntoQA snapshot</title></head><body><h1>Snapshot</h1>${htmlRows}</body></html>`; downloadBlob(doc, 'prontoqa_snapshot.html', 'text/html;charset=utf-8'); });

/* -------------------------
   File loading / sample / paste
   ------------------------- */
document.getElementById('file-input').addEventListener('change', (ev)=>{ const f = ev.target.files && ev.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = (e)=>{ try { const parsed = JSON.parse(e.target.result); loadDataArray(parsed); } catch(err){ alert('Failed to parse JSON: ' + err.message); } }; reader.readAsText(f,'utf-8'); });

document.getElementById('paste-json').addEventListener('click', ()=>{ document.getElementById('paste-modal').style.display = 'flex'; document.getElementById('paste-area').value = ''; });
document.getElementById('paste-cancel').addEventListener('click', ()=>{ document.getElementById('paste-modal').style.display='none'; });
document.getElementById('paste-load').addEventListener('click', ()=>{ const txt = document.getElementById('paste-area').value; try { const parsed = JSON.parse(txt); loadDataArray(parsed); document.getElementById('paste-modal').style.display = 'none'; } catch(err){ alert('Invalid JSON: ' + err.message); } });

document.getElementById('load-sample').addEventListener('click', ()=> loadDataArray(getSampleData()) );

/* drag & drop */
document.addEventListener('dragover', (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
document.addEventListener('drop', (e)=>{ e.preventDefault(); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev)=>{ try{ const p = JSON.parse(ev.target.result); loadDataArray(p);}catch(ex){alert('Parse error: '+ex.message)} }; r.readAsText(f); });

function loadDataArray(parsed){
  if(Array.isArray(parsed)) DATA = parsed;
  else if(parsed && typeof parsed === 'object') DATA = [parsed];
  else { alert('JSON should be an array or object'); return; }
  for(let i=0;i<DATA.length;i++){ if(DATA[i].id === undefined || DATA[i].id === null) DATA[i].id = 'idx_'+i; }
  PAGE = 1; SELECTED = new Set(); renderList();
}

/* -------------------------
   Sample data
   ------------------------- */
function getSampleData(){
  return [
{
  "id": "ProntoQA_328",
  "original_context": "Wumpuses adalah besar. Wumpuses adalah numpuses. Setiap numpus adalah logam. Wumpuses adalah yumpuses. ... Wren adalah wumpus.",
  "question": "Wren adalah transparan.",
  "translated_context": {
    "Translated_Facts": "Wumpus(Wren, True)",
    "Translated_Rules": "Wumpus($x, True) >>> Besar($x, True)\\nWumpus($x, True) >>> Numpus($x, True)\\nNumpus($x, True) >>> Logam($x, True)\\nNumpus($x, True) >>> Yumpus($x, True)",
    "Translated_Conjecture": "Transparan(Wren, True)"
  },
  "normalized_context": {
    "Fact": "Wumpus(Wren, True)",
    "and_or": "1. - \\\\left(Wumpus(x, False) \\\\lor Besar(x, True)\\\\right)\\n2. - \\\\left(Wumpus(x, False) \\\\lor Numpus(x, True)\\\\right)"
  },
  "normalized_conjecture": "Transparan(Wren, True)",
  "negated_label": "false",
  "sos_list": "Transparan(Wren, True)",
  "decomposition_process": {
    "and_or": "1. - \\\\left(Tumpus(x, False) \\\\lor Baik(x, True)\\\\right)\\n2. - \\\\left(Tumpus(x, False) \\\\lor Impus(x, True)\\\\right)"
  },
  "ground_truth": "A"
}
  ];
}

/* -------------------------
   Initialization: load sample by default
   ------------------------- */
loadDataArray(getSampleData());

/* update label options when resizing or data changes */
function refreshLabelFilterOptions(){
  const labels = Array.from(new Set(DATA.map(d => d.ground_truth).filter(Boolean)));
  const current = filterLabel.value;
  filterLabel.innerHTML = '<option value="">All</option>';
  for(const l of labels){
    const opt = document.createElement('option'); opt.value = l; opt.textContent = l; if(l === current) opt.selected = true;
    filterLabel.appendChild(opt);
  }
}
</script>
</body>
</html>
